<p>扩展存档文件是安全敏感的。例如，在过去扩展存档文件导致了以下漏洞：</p>
<ul>
  <li> <a href="http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-1263">CVE-2018-1263</a> </li>
  <li> <a href="http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-16131">CVE-2018-16131</a> </li>
</ul>
<p>展开归档文件的应用程序(zip、tar、jar、war、7z，…)应该验证归档文件展开的路径，不要盲目信任归档文件的内容。存档文件不应展开到应该展开存档文件的根目录之外。此外，应用程序应该控制扩展数据的大小，以避免成为Zip炸弹攻击的受害者。如果做不到这一点，攻击者可能会使用一个特别精心设计的存档文件，其中包含目录遍历路径(例如../../attack .sh)，或者攻击者可能会使扩展存档文件的操作系统的文件系统、处理器或内存过载，使目标操作系统完全不可用。</p>
<p>当代码处理归档时，此规则会引发一个问题。此目标是指导安全代码审查。</p>
<h2>检查是否有下列问题：</h2>
<ul>
  <li> 没有对存档项的名称进行验证 </li>
  <li> 没有对将要展开存档项的有效路径进行验证 </li>
  <li> 没有对扩展存档项的大小进行验证 </li>
  <li> 没有对压缩存档项和未压缩存档项之间的比例进行验证 </li>
</ul>
<p>如果对其中任何一个问题的回答是肯定的，那么就有风险。</p>
<p> </p>
<h2>推荐的安全编码实践</h2>
<p>根据展开文件目录的完整路径验证提取文件的完整路径。</p>
<ul>
  <li> 展开文件的规范路径必须从提取文件的目录的规范路径开始。</li>
  <li> 存档项的名称不能包含“..”，即引用父目录。</li>
</ul>
<p>如果存档的任何项已被目录遍历路径污染，则停止提取存档。</p>
<p>定义并控制压缩字节与解压字节之间的比例。</p>
<p>定义和控制允许的最大扩展文件大小。</p>
<p>计算从存档中提取的文件条目的数量，如果它们的数量大于预定义的阈值，则终止提取。</p>
<h2>可疑的代码示例</h2>
<pre>
foreach (ZipArchiveEntry entry in archive.Entries)
{
    //  可以包含父目录引用“..”，而destinationPath变量可以位于所需路径之外
    string destinationPath = Path.GetFullPath(Path.Combine(path, entry.FullName));

    entry.ExtractToFile(destinationPath); // 可疑的, 提取文件中的条目

    Stream stream;
    stream = entry.Open(); // 可疑的, 条目即将被提取
}
</pre>
<h2>请参阅</h2>
<ul>
  <li> <a href="http://cwe.mitre.org/data/definitions/409.html">MITRE, CWE-409</a> - Improper Handling of Highly Compressed Data (Data Amplification)
  </li>
  <li> OWASP Top 10 2017 Category A1 - Injection </li>
  <li> <a href="https://wiki.sei.cmu.edu/confluence/display/java/IDS04-J.+Safely+extract+files+from+ZipInputStream">CERT, IDS04-J.</a> - Safely
  extract files from ZipInputStream </li>
  <li> Snyk Research Team: <a href="https://snyk.io/research/zip-slip-vulnerability">Zip Slip Vulnerability</a> </li>
</ul>

